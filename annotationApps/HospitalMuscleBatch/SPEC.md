# HospitalMuscleBatch — 仕様書

最終更新: 2026-02-19

---

## 1. アプリ概要

眼筋 MRI（DICOM コロナル断）を対象とした **一括セグメンテーション & レビュー GUI**。

- nnU-Net (Dataset119) で 6 種類の眼外筋（左右計 12 ラベル）を自動セグメンテーション。
- バッチ処理で複数患者を連続推論し、終了後にリストからクリックしてレビュー。
- 測定値（体積・最大断面積）を CSV に自動保存し、NIfTI 予測マスクも保持。

---

## 2. ディレクトリ構成

```
HospitalMuscleBatch/
├── app/
│   ├── gui/
│   │   ├── MuscleGUI.py          # メイン GUI・推論ロジック
│   │   ├── result_manager.py     # CSV / NIfTI 保存管理
│   │   ├── dicom_handler.py      # DICOM → NIfTI 変換
│   │   └── run_nnunet.py         # nnU-Net サブプロセス呼び出し
│   └── ...
├── output/
│   └── 119/
│       ├── predictions/          # {id}_pred.nii.gz
│       └── csv/
│           └── muscle_measurements.csv
├── manual_review/
│   └── pending_review.json
├── SPEC.md                       # 本ファイル
└── ROADMAP.md
```

---

## 3. 入力データ形式

### 親フォルダ選択

GUI の「📁 親フォルダを選択」で **Data.txt を含む親フォルダ**を選択する。
Data.txt はサブフォルダを再帰検索して収集される。

### Data.txt フォーマット

```
PatientName:(ID:147757)[20230104]
    Series No.302(MR)[eT1W_SE_cor]    Directory: DATA\147757\20240508\112048\EX1\SE1
```

- `Directory:` 以降の相対パスが DICOM フォルダとして解釈される。
- デフォルトのシリーズフィルタは `eT1W_SE_cor`（GUI で変更可能）。
- ID は `DATA\` 以降のパス要素を `_` で結合して生成（例: `147757_20240508_112048_EX1_SE1`）。

---

## 4. 処理フロー

```
親フォルダ選択
  └─ Data.txt 解析 → batch_queue 生成
       └─ 一括処理開始ボタン
            ├─ DICOM → NIfTI 変換 (SimpleITK)
            ├─ is_prediction_valid? (NIfTI キャッシュ確認)
            │    ├─ Yes → LoadExistingThread (推論スキップ)
            │    └─ No  → PredictionThread (nnU-Net 推論)
            │         └─ CUDA 失敗時: CPU で自動リトライ
            ├─ on_prediction_finished
            │    ├─ NIfTI 保存 (新規のみ)
            │    ├─ CSV 追記 (行がない場合のみ / キャッシュでも行なし→補完)
            │    └─ completed_results に追記
            └─ 全件完了 → レビューモード移行
```

---

## 5. GUI レイアウト

### 左パネル（幅 380〜420px）

| セクション | 主な要素 |
|---|---|
| バッチ処理設定 | 親フォルダ選択・フォルダ名表示・シリーズ数・シリーズフィルタ入力・デバイス選択 (cuda/cpu) |
| 処理実行 | 一括処理開始ボタン・ステータスラベル・進捗バー |
| 患者リスト | バッチ完了後に表示。○/✓/△ アイコンでレビューステータスを色分け |
| 表示設定 | 画像上のラベル名表示チェックボックス |
| 筋肉の体積 (cm³) | **3タブ構成**（後述）。ホイールスクロールでタブが切り替わらないよう制御済み |
| 現在のスライスの面積 (cm²) | スライスごとの筋肉別断面積ツリー |
| ❓ 操作一覧ボタン | クリックでポップアップ（QMessageBox + HTML テーブル） |

### 右パネル

| セクション | 主な要素 |
|---|---|
| レビューアクションバー | 患者 ID 表示・スライス番号・✓ 確認ボタン・✎ 修正ボタン |
| ズームスライダー | 範囲 120〜200%、デフォルト 130%、tick 10% 刻み |
| 画像表示 | マウスホイールでスライス切替 |
| スライスバー | スライス位置のスライダー |

---

## 6. 体積計算の 3 方式

バッチ処理・キャッシュ読み込み問わず毎回計算される。

| タブ名 | 計算対象スライス | 備考 |
|---|---|---|
| 全スライス | 全スライス | 従来互換 |
| 動的範囲 | so/sr/mr/lr/ir が両側(l・r)すべて検出されているスライス | io は条件に含めない |
| 固定範囲 | スライス 5〜11（0始まりインデックス） | 固定の解剖学的範囲 |

- 動的範囲ラベルには **1始まりのスライス番号**（例: `範囲: 4-10`）を表示。
- 固定範囲ラベルは静的に `範囲: 5〜11` を表示。

---

## 7. 左右（L/R）判定の規則

**放射線医学的表示規則**に従う。

| 画像上の位置 | 患者の側 | ラベル |
|---|---|---|
| 画像の左（低 X） | 患者の**右** | `r_xx` |
| 画像の右（高 X） | 患者の**左** | `l_xx` |

判定箇所: `NnUNetPredictor.visualize_slice` 内の重心 X 座標比較。

```python
side = "r" if center_x < img_width // 2 else "l"
```

---

## 8. ラベル定義

| ラベル ID | 筋肉名（英） | 筋肉名（日） |
|---|---|---|
| 1 | ir | 下直筋 |
| 2 | mr | 内直筋 |
| 3 | sr | 上直筋 |
| 4 | so | 上斜筋 |
| 5 | lr | 外直筋 |
| 6 | io | 下斜筋 |

左右を付与すると `l_ir` / `r_ir` などの形式になる（12 ラベル）。

---

## 9. 出力ファイル

### 9-1. 予測 NIfTI

- パス: `output/119/predictions/{id}_pred.nii.gz`
- 内容: ラベル値 0〜6 の整数マスク（Z,Y,X 順）

### 9-2. CSV

- パス: `output/119/csv/muscle_measurements.csv`
- 文字コード: UTF-8
- 1行 = 1検査

| 列グループ | 列名 | 内容 |
|---|---|---|
| メタ | `folder_name`, `timestamp` | ID と処理日時 |
| vol_all | `r_ir`, `l_ir`, ... (12列) | 全スライス体積 (cm³) |
| vol_dyn | `r_ir_dyn`, ... (12列) | 動的範囲体積 (cm³) |
| vol_fix | `r_ir_fix`, ... (12列) | 固定範囲体積 (cm³) |
| — | `vol_dyn_range` | 動的範囲のスライス番号文字列 |
| area | `r_ir_area`, ... (12列) | 全スライス中の最大断面積 (cm²) |
| — | `review_status` | `pending` / `confirmed` / `needs_correction` |

ラベル順序: `r_ir, l_ir, r_mr, l_mr, r_sr, l_sr, r_so, l_so, r_lr, l_lr, r_io, l_io`

**NIfTI あり・CSV 行なしの場合**: 次回バッチ実行時に CSV 行を自動補完する（再推論は行わない）。

---

## 10. レビューワークフロー

1. バッチ完了後、左パネルに患者リストが表示される。
2. リストをクリックすると対象患者の画像・体積・面積が右パネルに表示される。
3. **✓ 確認** または **✎ 修正** をクリックするとステータスが更新され、次の未判定患者に自動移動する。
4. ステータス変更は即座に CSV の `review_status` 列に書き込まれる。
5. Excel で CSV を開いている場合は PermissionError ダイアログで通知される。

---

## 11. デバイス設定

- 起動時に `nvidia-smi` で GPU を検出し、見つかれば cuda モードに自動設定。
- cuda で推論失敗した場合は CPU で自動リトライし、以降の処理もすべて CPU に切り替える。
- GUI のデバイス選択コンボボックスでも手動変更可能。

---

## 12. 既知の制約・注意事項

- シリーズフィルタを空にすると Data.txt の全シリーズが対象になる。
- CSV がすでに Excel で開かれている状態で処理すると書き込みエラーになる（Excel を閉じてから実行すること）。
- 修正ツール（ブラシ編集）は未実装（ROADMAP Phase 3 参照）。
- `manual_review/pending_review.json` は現在 GUI から直接は更新されない（将来の拡張用）。
